<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Hallow Trials â€” Enter if you dare</title>
  <link rel="icon" href="ht-removebg-preview.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    body{ padding-bottom: var(--safe-bottom); }
    header{ padding-top: max(0px, var(--safe-top)); }
    :root{
      --bg:#0a0a0f;--bg-2:#0f0a12;--ink:#e6e3ff;--ash:#9a94b8;--blood:#b10f2e;--ecto:#6b4dff;
      --card:#121018;--max:1400px;--safe-top: env(safe-area-inset-top);--safe-bottom: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{margin:0;font-family:Inter,sans-serif;color:var(--ink);background:linear-gradient(180deg,var(--bg),var(--bg-2));min-height:100vh;display:flex;flex-direction:column}
    a{color:inherit;text-decoration:none}

    header{position:sticky;top:0;z-index:30;background:rgba(10,10,15,.9);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.05)}
    nav{max-width:var(--max);margin:0 auto;display:flex;align-items:center;gap:24px;padding:20px 32px;width:100%}
    .brand{font-family:Cinzel,serif;letter-spacing:3px;font-weight:700;font-size:22px;color:var(--ink)}
    .brand .glyph{color:var(--blood)}
    .navlinks{margin-left:auto;display:flex;gap:28px;flex-wrap:wrap}
    .navlinks a{opacity:.9;text-decoration:none;font-weight:500;color:var(--ink);transition:.2s}
    .navlinks a:hover{color:var(--blood)}

    section{width:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:80px 20px}

    /* ===== HERO ===== */
    .hero{
      max-width:var(--max);
      margin:0 auto;
      min-height:calc(100vh - 80px);
      width:100%;
      display:grid;
      grid-template-columns: minmax(300px, 1.1fr) minmax(280px, .9fr);
      gap:44px;
      align-items:center;
    }
    .hero-left{width:100%;max-width:880px;justify-self:stretch}
    .title{font-family:Cinzel,serif;font-size:clamp(42px,6vw,80px);margin:0 0 16px;text-shadow:0 0 40px rgba(107,77,255,.35)}
    .subtitle{color:var(--ash);margin-bottom:16px;line-height:1.6;font-size:18px}

    .panel{
      background:var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-radius:20px;
      padding:32px;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
      position:relative;
      overflow:visible;
      width:100%;
    }
    .panel h3{font-family:Cinzel,serif;font-size:24px;margin-bottom:16px}

    .hero-right{
      position:relative;width:100%;border-radius:22px;overflow:hidden;
      box-shadow:0 0 30px 2px rgba(158, 1, 1, .9);background:#0f0a14;aspect-ratio: 4.2 / 5;
    }
    .hero-right img{display:block;width:100%;height:100%;object-fit:cover;filter:contrast(4.5) brightness(.8) saturate(3.5);}

    /* ===== Countdown ===== */
    #countdown{min-height:100vh;gap:28px}
    .cd-wrap{max-width:var(--max);margin:0 auto;display:grid;grid-template-columns:1.1fr .9fr;gap:40px;align-items:center}
    .cd-title{font-family:Cinzel,serif;font-size:clamp(34px,5.5vw,70px);line-height:1.05;text-align:left}
    .cd-sub{color:var(--ash);margin-top:10px}
    .tiles{display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:14px;margin-top:24px}
    .tile{background:radial-gradient(160% 120% at 50% 0%, #1b1324 0%, #110c16 50%, #0d0b12 100%);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.55), inset 0 0 40px rgba(177,15,46,.08);padding:18px;text-align:center}
    .tile .num{font-feature-settings:"tnum" 1; font-variant-numeric:tabular-nums; font-weight:700; font-size:clamp(34px,6vw,60px)}
    .tile .lbl{color:var(--ash);font-size:13px;margin-top:6px}

    /* ===== Puzzle ===== */
    #puzzle{max-width:var(--max);margin:0 auto;gap:28px}
    .puzzle-intro{max-width:820px;text-align:center;color:var(--ash)}
    .codebar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:14px}
    .codebar input{background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:var(--ink);padding:12px 14px;border-radius:12px;min-width:260px;text-transform:uppercase;letter-spacing:1px}
    .codebar button{background:#1c1529;border:1px solid rgba(255,255,255,.14);color:var(--ink);padding:12px 16px;border-radius:12px;cursor:pointer}

    .chest-grid{width:100%;display:grid;gap:18px;margin-top:26px;grid-template-columns:repeat(3,minmax(220px,1fr))}
    .chest{position:relative;aspect-ratio:1/1;background:#0f0a14;border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .reveal img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transition:opacity .35s ease, transform .35s ease;filter:grayscale(.15) contrast(1.05) brightness(.9)}
    .reveal .label{position:relative;z-index:1;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.2);color:var(--ink);padding:8px 10px;border-radius:10px;text-align:center;width:100%;font-weight:600}

    /* ===== Registration ===== */
    #register{max-width:900px;margin:0 auto}
    .reg-wrap{width:100%;display:grid;gap:24px}
    .reg-card{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.6);width:100%}
    .reg-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .reg-grid .full{grid-column:1 / -1}
    .field{display:flex;flex-direction:column;gap:8px}
    .field label{font-weight:700;letter-spacing:.2px}
    .field input,.field select{background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:var(--ink);padding:12px 14px;border-radius:12px;font-size:16px}
    .muted{color:var(--ash);font-size:14px}
    .price{font-size:18px;font-weight:800}
    .btn{border:none;background:linear-gradient(180deg,#1c1529,#0f0a14);color:var(--ink);padding:14px 24px;border-radius:14px;cursor:pointer;font-weight:700}
    .btn:hover{background:#2a1c3d}
    .soldout{opacity:.6;pointer-events:none}

    .slotbar{height:10px;border-radius:999px;background:#1b1324;border:1px solid rgba(255,255,255,.08);overflow:hidden}
    .slotbar > span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#b10f2e,#6b4dff)}
    .slots{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:12px 0 4px}
    .slots b{font-size:18px}
    .small{font-size:13px;color:#cdbef3}

    .pay-methods{display:flex;gap:16px;flex-wrap:wrap;margin-top:6px}
    .pay-methods .radio{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    .pay-methods input[type="radio"]{accent-color:#b10f2e}

    .pay-block.hidden{display:none}
    .qr-wrap{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;background:#0b0b12;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px}
    .qr-img{width:140px;height:140px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.1)}
    .confirm{display:flex;align-items:center;gap:8px;margin-top:8px}

    /* Footer */
    .site-footer{margin-top:80px;background:#0b0b10;border-top:1px solid rgba(255,255,255,.06)}
    .footer-inner{max-width:var(--max);margin:0 auto;padding:34px 24px 22px;display:flex;align-items:center;gap:26px}
    .f-nav{margin-left:auto;margin-right:auto;display:flex;gap:28px;color:#cfc9ea;font-weight:600;font-size:14px;opacity:.9}
    .foot-bottom{max-width:var(--max);margin:0 auto;padding:14px 24px 34px;display:flex;justify-content:center;gap:10px;color:#bdb7d8;font-size:13px;opacity:.85}

    /* Responsive tweaks */
    @media(max-width:1024px){ .hero{grid-template-columns:1fr;gap:28px;min-height:auto}.hero-right{aspect-ratio:16/9} }
    @media(max-width:768px){ nav{flex-direction:column;gap:12px}.title{font-size:clamp(32px,8vw,56px)}.reg-grid{grid-template-columns:1fr} }
    @media(max-width:560px){ .tiles{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:480px){ .chest-grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="brand"><span class="glyph">ð“‰¸</span><a href="#home"> HALLOW TRIALS</a></div>
      <div class="navlinks">
        <a href="#countdown">Countdown</a>
        <a href="#video">Short Video</a>
        <a href="#puzzle">Puzzle</a>
        <a href="#register">Register</a>
      </div>
    </nav>
  </header>

  <!-- ===== HERO ===== -->
  <section id="home" class="hero">
    <div class="hero-left">
      <h1 class="title">Enter the <span style="color:var(--blood)">Trials</span></h1>
      <p class="subtitle">A one-night pop-up where we unleash handcrafted spooky mini-games. Play them on site, watch our behind-the-scenes shorts, and crack the hidden codes woven into this very page.</p><br><br>

      <div class="panel" aria-label="Event Details">
        <h3>Event Details</h3>
        <p><strong>Date:</strong> 31 Oct, 8:00PM â€” 11:00PM</p><br>
        <p><strong>Venue:</strong> Level 9 to 7</p><br>
        <p><strong>What to expect:</strong> 6 eerie arcade cabinets, live screams, candy, and a site-wide code hunt.</p>
      </div>
    </div>
    <figure class="hero-right" aria-label="Scary scene">
      <img src="poster.jpg" alt="Poster">
    </figure>
  </section>

  <!-- ===== Countdown ===== -->
  <section id="countdown">
    <div class="cd-wrap">
      <div>
        <h2 class="cd-title">The <span style="color:var(--blood)">Hallow Trials</span> begin inâ€¦</h2>
        <p class="cd-sub">Doors creak at <strong>8:00 PM</strong> on Halloween night. When the clock hits zero, the warehouse opens.</p>
        <div class="tiles" role="timer" aria-live="polite">
          <div class="tile"><div class="num" id="dd">â€”</div><div class="lbl">Days</div></div>
          <div class="tile"><div class="num" id="hh">â€”</div><div class="lbl">Hours</div></div>
          <div class="tile"><div class="num" id="mm">â€”</div><div class="lbl">Minutes</div></div>
          <div class="tile"><div class="num" id="ss">â€”</div><div class="lbl">Seconds</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Short Video ===== -->
  <section id="video" class="short-video">
    <div class="panel" style="max-width:var(--max);width:100%;">
      <h3 style="font-family:Cinzel,serif;font-size:clamp(32px,4vw,44px);margin-bottom:16px">Short Video</h3>
      <p class="muted" style="margin-bottom:12px">Get a sneak peek into the haunted halls. Watch this teaser to feel the chill before you enter the Trials.</p>
      <div class="short-video-card" style="aspect-ratio:16/9;overflow:hidden;border-radius:20px;border:1px solid rgba(255,255,255,.08);background:#0f0a14;box-shadow:0 20px 40px rgba(0,0,0,.6)">
        <iframe 
          width="640" height="360"
          src="https://www.youtube.com/embed/oXEOtlU-dAs?si=N0idKdyqvgRc9nei"
          title="YouTube video player" frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
          style="width:100%;height:100%;border:0;display:block;border-radius:20px">
        </iframe>
      </div>
    </div>
  </section>

  <!-- ===== Puzzle ===== -->
  <section id="puzzle">
    <h2 class="title" style="font-size:clamp(34px,4.6vw,56px);text-align:center;">Site-Wide Puzzle: <span style="color:var(--blood)">Find & Unlock</span></h2>
    <p class="puzzle-intro">
      Hunt the campus for hidden codes. Each correct code unlocks a chained chest below and reveals one of the games weâ€™ll run that night.
      Enter codes in <strong>any order</strong>. Progress is saved on your device.
    </p>
    <div class="codebar">
      <input id="codeInput" placeholder="ENTER CODE" autocomplete="off" spellcheck="false" />
      <button id="submitCode">Unlock</button>
      <button id="resetCodes" title="Clear local progress">Reset</button>
    </div>
    <div class="muted" id="progressNote" style="margin-top:6px">0 / 9 unlocked</div>
    <div class="chest-grid" id="chestGrid"></div>
    <div class="toast" id="toast"></div>
  </section>

  <!-- REGISTER START -->
<section id="register" style="max-width:900px;margin:0 auto;padding:80px 20px">
  <h2 style="font-family:Cinzel,serif;font-size:clamp(34px,4.6vw,56px);text-align:center;margin-bottom:10px;">
    Register for <span style="color:#b10f2e">Hallow Trials</span>
  </h2>
  <p class="muted" style="text-align:center;max-width:780px;margin:0 auto 18px;color:#9a94b8">
    Only <strong>200</strong> spots are available. Tickets are <strong>RM10</strong> per person.
    On submit weâ€™ll notify <strong>hallowtrials@gmail.com</strong>.
  </p>

  <div class="reg-card" style="background:#121018;border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.6)">
    <div class="slots" style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin:12px 0 8px">
      <b style="font-size:18px">Remaining: <span id="slots-left">â€”</span> / 200</b>
      <span class="small" style="font-size:13px;color:#cdbef3">Booked: <span id="slots-booked">â€”</span></span>
    </div>
    <div class="slotbar" aria-hidden="true" style="height:10px;border-radius:999px;background:#1b1324;border:1px solid rgba(255,255,255,.08);overflow:hidden">
      <span id="slotbar-fill" style="display:block;height:100%;width:0%;background:linear-gradient(90deg,#b10f2e,#6b4dff)"></span>
    </div>
    <div id="regError" style="color:#ffb3b3;margin-top:8px;display:none"></div>

    <form id="regForm" class="reg-grid" autocomplete="on" novalidate
          style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:14px">
      <!-- Payment Method -->
      <div class="field full" style="grid-column:1 / -1;display:flex;flex-direction:column;gap:8px">
        <label style="font-weight:700;letter-spacing:.2px">Payment method</label>
        <div class="pay-methods" style="display:flex;gap:16px;flex-wrap:wrap">
          <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
            <input type="radio" name="payMethod" value="cash" checked style="accent-color:#b10f2e"> <span>Pay on-site (Cash)</span>
          </label>
          <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
            <input type="radio" name="payMethod" value="qr" style="accent-color:#b10f2e"> <span>DuitNow QR / Online Transfer</span>
          </label>
          <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
            <input type="radio" name="payMethod" value="bank" style="accent-color:#b10f2e"> <span>Bank Transfer / Card via Bank</span>
          </label>
        </div>
        <p class="muted" style="color:#9a94b8">Total due updates with your ticket quantity.</p>
      </div>

      <!-- QR block -->
      <div id="qrBlock" class="full" style="grid-column:1 / -1;display:none">
        <div class="qr-wrap" style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;background:#0b0b12;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px">
          <img src="maybank-qr.png" alt="Maybank DuitNow QR" style="width:140px;height:140px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.1)">
          <div>
            <p><b>Payee:</b> Pyae Phyo Kyaw</p>
            <p><b>Amount:</b> RM <span id="qrAmount">10</span></p>
            <p><b>Reference to include:</b> HALLOW-<span id="qrRefCode">XXXXXX</span></p>
            <div class="muted" style="margin-top:6px;color:#9a94b8">After paying, upload your proof (screenshot/receipt) and tick the confirmation below.</div>

            <label class="field" style="display:flex;flex-direction:column;gap:6px;margin-top:10px">
              <span>Upload payment proof (image, max 5MB)</span>
              <input id="qrProof" type="file" accept="image/*" style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:10px;border-radius:10px">
            </label>
            <div id="qrPreview" class="muted" style="display:none;margin-top:6px;color:#9a94b8"></div>

            <label style="display:flex;align-items:center;gap:8px;margin-top:8px">
              <input type="checkbox" id="paidConfirm"> <span>I have completed the QR/online transfer.</span>
            </label>

            <label class="field" style="display:flex;flex-direction:column;gap:6px;margin-top:10px">
              <span>Payment reference (optional)</span>
              <input id="payRef" placeholder="Maybank Ref No. / TNG ID"
                     style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:12px;border-radius:12px">
            </label>
          </div>
        </div>
      </div>

      <!-- Bank block -->
      <div id="bankBlock" class="full" style="grid-column:1 / -1;display:none">
        <div class="qr-wrap" style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;background:#0b0b12;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px">
          <div>
            <p><b>Bank:</b> Maybank</p>
            <p><b>Account name:</b> Pyae Phyo Kyaw</p>
            <p><b>Account no.:</b> <code style="user-select:all">5648 3866 0096</code></p>
            <p><b>Amount:</b> RM <span id="bankAmount">10</span></p>
            <p class="muted" style="color:#9a94b8">Transfer using your bank / card to the account above, then upload your receipt below.</p>

            <label class="field" style="display:flex;flex-direction:column;gap:6px;margin-top:10px">
              <span>Upload payment proof (image, max 5MB)</span>
              <input id="bankProof" type="file" accept="image/*"
                     style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:10px;border-radius:10px">
            </label>
            <div id="bankPreview" class="muted" style="display:none;margin-top:6px;color:#9a94b8"></div>

            <label class="field" style="display:flex;flex-direction:column;gap:6px;margin-top:10px">
              <span>Payment reference (optional)</span>
              <input id="bankRef" placeholder="Bank/Card reference number"
                     style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:12px;border-radius:12px">
            </label>
          </div>
        </div>
      </div>

      <div class="field">
        <label for="fullName" style="font-weight:700">Full name</label>
        <input id="fullName" name="fullName" placeholder="Jane Ghoul"
               style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:12px;border-radius:12px" required>
      </div>

      <div class="field">
        <label for="email" style="font-weight:700">Email</label>
        <input id="email" name="email" type="email" placeholder="you@example.com"
               style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:12px;border-radius:12px" required>
      </div>

      <div class="field">
        <label for="qty" style="font-weight:700">Number of tickets</label>
        <select id="qty" name="qty"
                style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:12px;border-radius:12px">
          <option value="1" selected>1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
        </select>
      </div>

      <div class="field">
        <label style="font-weight:700">Total price</label>
        <div class="price">RM <span id="totalPrice">10</span></div>
        <div class="muted" style="color:#9a94b8">RM10 per person</div>
      </div>

      <div class="field full" style="grid-column:1 / -1">
        <label for="note" style="font-weight:700">Note (optional)</label>
        <input id="note" name="note" placeholder="Any special requests?"
               style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:12px;border-radius:12px">
      </div>

      <div class="full" style="grid-column:1 / -1;display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:6px">
        <button id="submitReg" class="btn" type="submit"
                style="border:none;background:linear-gradient(180deg,#1c1529,#0f0a14);color:#e6e3ff;padding:14px 24px;border-radius:14px;font-weight:700">
          Reserve My Spot
        </button>
        <span id="regStatus" class="muted" role="status" aria-live="polite" style="color:#9a94b8"></span>
      </div>
    </form>
  </div>
</section>

<!-- Optional EmailJS (kept for fallback) -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
/* ===== CONFIG â€“ update only API_URL if you redeploy ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbxlEAVWRpncfClDj5MaEfg93nByp3wuyMsUFZiiWQHe8ueKT1BnItp2KwXVYOoKI5c/exec';
const CAPACITY = 200, PRICE = 10;
// EmailJS fallback (leave placeholders to use "mailto" instead):
const EMAILJS_PUBLIC_KEY='YOUR_PUBLIC_KEY_HERE', EMAILJS_SERVICE_ID='YOUR_SERVICE_ID', EMAILJS_TEMPLATE_ID='YOUR_TEMPLATE_ID';
if (EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY!=='YOUR_PUBLIC_KEY_HERE') emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });

/* ===== DOM ===== */
const elSlotsLeft   = document.getElementById('slots-left');
const elSlotsBooked = document.getElementById('slots-booked');
const elSlotbar     = document.getElementById('slotbar-fill');
const regError      = document.getElementById('regError');

const form          = document.getElementById('regForm');
const qtySel        = document.getElementById('qty');
const totalPriceEl  = document.getElementById('totalPrice');
const submitBtn     = document.getElementById('submitReg');
const regStatus     = document.getElementById('regStatus');

const payMethodInputs = document.querySelectorAll('input[name="payMethod"]');
const qrBlock    = document.getElementById('qrBlock');
const bankBlock  = document.getElementById('bankBlock');
const paidConfirm= document.getElementById('paidConfirm');
const payRef     = document.getElementById('payRef');
const bankRef    = document.getElementById('bankRef');
const qrAmount   = document.getElementById('qrAmount');
const bankAmount = document.getElementById('bankAmount');
const qrRefCode  = document.getElementById('qrRefCode');
const qrProof    = document.getElementById('qrProof');
const bankProof  = document.getElementById('bankProof');
const qrPreview  = document.getElementById('qrPreview');
const bankPreview= document.getElementById('bankPreview');

/* ===== Helpers ===== */
const toast = (m)=>alert(m);
const currentPayMethod = ()=> {
  const m=[...payMethodInputs].find(r=>r.checked); return m?m.value:'cash';
};
function refreshPrice(){
  const total=(Number(qtySel.value)||1)*PRICE;
  totalPriceEl.textContent=String(total);
  qrAmount.textContent=String(total);
  bankAmount.textContent=String(total);
}
function updatePaymentUI(){
  const method=currentPayMethod();
  qrBlock.style.display   = method==='qr'   ? 'block' : 'none';
  bankBlock.style.display = method==='bank' ? 'block' : 'none';
  qrRefCode.textContent = (Date.now().toString(36).toUpperCase()).slice(-6);
  refreshPrice();
}
function previewFile(inputEl, previewEl){
  const file=inputEl.files && inputEl.files[0];
  if(!file){ previewEl.style.display='none'; previewEl.innerHTML=''; delete previewEl.dataset.base64; return; }
  if(file.size>5*1024*1024){ inputEl.value=''; previewEl.style.display='block'; previewEl.textContent='File too large (max 5MB).'; delete previewEl.dataset.base64; return; }
  const reader=new FileReader();
  reader.onload=()=>{ previewEl.style.display='block'; previewEl.innerHTML=`<img src="${reader.result}" alt="proof" style="max-width:160px;max-height:160px;border-radius:8px;border:1px solid rgba(255,255,255,.15)">`; previewEl.dataset.base64=reader.result; };
  reader.readAsDataURL(file);
}

/* ===== API ===== */
async function apiGetStats(){
  const res=await fetch(API_URL+'?fn=stats',{method:'GET',cache:'no-store'});
  const text=await res.text();
  try { var data = JSON.parse(text); } catch(e){ throw new Error('Bad JSON: '+text); }
  if(!res.ok || !data.ok) throw new Error((data && data.error) || ('HTTP '+res.status));
  return data; // {ok, capacity, booked, remaining}
}
async function apiRegister(payload){
  // Use text/plain to avoid CORS preflight on GitHub Pages
  const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
  const text=await res.text(); let data={};
  try{ data=JSON.parse(text);}catch(e){ throw new Error('Bad JSON: '+text); }
  if(!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
  return data; // {ok, proofUrl?, capacity, booked, remaining}
}
function updateSlotsUI(stats){
  const booked=Number(stats.booked||0), remaining=Math.max(0, Number(stats.remaining||0));
  elSlotsBooked.textContent=booked; elSlotsLeft.textContent=remaining;
  elSlotbar.style.width=Math.min(100,(booked/CAPACITY)*100)+'%';
  const soldOut = remaining<=0;
  submitBtn.disabled=soldOut; submitBtn.textContent=soldOut?'Sold Out':'Reserve My Spot';
  submitBtn.style.opacity = soldOut ? .6 : 1;
}

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  payMethodInputs.forEach(r=>r.addEventListener('change',updatePaymentUI));
  qtySel.addEventListener('change',refreshPrice);
  qrProof.addEventListener('change',()=>previewFile(qrProof,qrPreview));
  bankProof.addEventListener('change',()=>previewFile(bankProof,bankPreview));

  refreshPrice(); updatePaymentUI();

  try { updateSlotsUI(await apiGetStats()); regError.style.display='none'; }
  catch(err){ regError.style.display='block'; regError.textContent='Could not load live capacity: '+err.message; }
});

/* ===== Submit ===== */
form.addEventListener('submit', async (e)=>{
  e.preventDefault(); regStatus.textContent='';
  const fullName=document.getElementById('fullName').value.trim();
  const email=document.getElementById('email').value.trim();
  const qty=Number(qtySel.value)||1;
  const note=document.getElementById('note').value.trim();
  const total=qty*PRICE;

  if(!fullName || !email){ toast('Please fill your name and a valid email.'); return; }

  const payMethod=currentPayMethod(); let reference=''; let proofDataURL='';
  if(payMethod==='qr'){
    if(!paidConfirm.checked){ toast('Tick the confirmation box after completing the QR/transfer.'); return; }
    if(!qrPreview.dataset.base64){ toast('Please upload your QR payment screenshot.'); return; }
    proofDataURL=qrPreview.dataset.base64; reference=(payRef.value||'').trim();
  }
  if(payMethod==='bank'){
    if(!bankPreview.dataset.base64){ toast('Please upload your bank/card receipt screenshot.'); return; }
    proofDataURL=bankPreview.dataset.base64; reference=(bankRef.value||'').trim();
  }

  submitBtn.disabled=true; submitBtn.textContent='Processingâ€¦';
  try {
    const resp=await apiRegister({ fullName,email,qty,total,payMethod,reference,note,imageDataURL:proofDataURL || '' });
    updateSlotsUI(resp);

    // Email notify
    const proofLink=resp.proofUrl || '';
    if (EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY!=='YOUR_PUBLIC_KEY_HERE'){
      await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
        to_email:'hallowtrials@gmail.com', full_name:fullName, email,
        qty:String(qty), total_rm:String(total), note,
        pay_method:payMethod, pay_reference:reference || '', proof_link:proofLink
      });
    } else {
      const subject=encodeURIComponent('Hallow Trials Registration');
      const lines=[
        `New registration:`,
        `Name: ${fullName}`,`Email: ${email}`,`Qty: ${qty}`,`Total: RM ${total}`,
        `Payment: ${payMethod}${reference?' ('+reference+')':''}`,
        `Proof link: ${proofLink || '-'}`,`Note: ${note || '-'}`
      ];
      window.location.href=`mailto:hallowtrials@gmail.com?subject=${subject}&body=${encodeURIComponent(lines.join('\n'))}`;
    }

    toast('Booking received! Check your email.');
    regStatus.textContent=`Booked ${qty} ticket(s). Total RM${total}.`;
    form.reset(); refreshPrice(); updatePaymentUI();
    [qrPreview,bankPreview].forEach(el=>{el.style.display='none';el.innerHTML='';delete el.dataset.base64;});
  } catch(err){
    console.error(err);
    toast('Failed to register: '+err.message);
    regStatus.textContent='Error. Please try again or email us directly.';
  } finally {
    submitBtn.disabled=false; submitBtn.textContent='Reserve My Spot';
  }
});
</script>
<!-- REGISTER END -->


  <!-- ===== Footer ===== -->
  <footer class="site-footer" role="contentinfo">
    <div class="footer-inner">
      <div class="f-logo" aria-label="Site logo" style="display:flex;gap:12px;align-items:center;font-weight:800;letter-spacing:2px">
        <svg viewBox="0 0 64 64" aria-hidden="true" width="34" height="34">
          <defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="#2a1a1f"/><stop offset="1" stop-color="#110c12"/></linearGradient></defs>
          <rect x="10" y="6" width="44" height="52" rx="10" fill="url(#g)" stroke="#36212a"/>
          <circle cx="32" cy="30" r="9" fill="#e8dfcf"/>
          <path d="M27 34h10M28 30a2 2 0 1 0 0 .01M36 30a2 2 0 1 0 0 .01" stroke="#2b1f1f" stroke-width="2" fill="none"/>
        </svg>
        <span class="glyph">HALLOW TRIALS</span>
      </div>

      <nav class="f-nav" aria-label="Footer">
        <a href="#home">Home</a>
        <a href="#countdown">Countdown</a>
        <a href="#video">Videos</a>
        <a href="#puzzle">Puzzle</a>
      </nav>

      <div style="display:flex;gap:14px">
        <a href="https://www.youtube.com/@APUvcc" target="_blank" rel="noopener" title="YouTube" aria-label="YouTube" style="display:inline-grid;place-items:center;width:34px;height:34px;border-radius:50%;border:1px solid rgba(255,255,255,.12);opacity:.9">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="#d9d5ff"><path d="M23.5 6.2s-.2-1.6-.9-2.3c-.9-.9-1.9-.9-2.4-1C16.8 2.6 12 2.6 12 2.6h-.1s-4.8 0-8.2.3c-.5.1-1.5.1-2.4 1-.7.7-.9 2.3-.9 2.3S0 8.2 0 10.3v1.5c0 2.1.2 4.1.2 4.1s.2 1.6.9 2.3c.9.9 2.1.9 2.7 1 2 .2 8.2.3 8.2.3s4.8 0 8.2-.3c.5-.1 1.5-.1 2.4-1 .7-.7.9-2.3.9-2.3s.2-2 .2-4.1v-1.5c0-2.1-.2-4.1-.2-4.1zM9.6 14.7v-5.3l5.6 2.7-5.6 2.6z"/></svg>
        </a>
        <a href="https://www.instagram.com/hallowtrials/" target="_blank" rel="noopener" title="Instagram" aria-label="Instagram" style="display:inline-grid;place-items:center;width:34px;height:34px;border-radius:50%;border:1px solid rgba(255,255,255,.12);opacity:.9">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="#d9d5ff"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0 2.2A2.8 2.8 0 1 0 12 15.8 2.8 2.8 0 0 0 12 9.2zm6.2-.9a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
        </a>
      </div>
    </div>

    <div class="foot-bottom">
      <span>Â© Copyright. All rights reserved.</span>
      <span class="made-by">â€¢ Created by
        <a class="ash-logo" href="https://ash1537.github.io/Portfolio/HOME%20_%20Portfolio.html" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid rgba(255,255,255,.12);border-radius:999px">
          <svg viewBox="0 0 24 24" aria-hidden="true" width="18" height="18"><path fill="#ff294b" d="M12 3l3.2 7.6L23 11l-6.5 5.3L18.4 21 12 17.4 5.6 21l1.9-4.7L1 11l7.8-.4L12 3z"/></svg>
          <b>ASH</b>
        </a>
      </span>
    </div>
  </footer>

  <!-- ===== Countdown ===== -->
  <script>
    function nextHalloween(year){ return new Date(year, 9, 31, 20, 0, 0); }
    (function runCountdown(){
      const now = new Date();
      let target = nextHalloween(now.getFullYear());
      if (now > target) target = nextHalloween(now.getFullYear()+1);

      const dd = document.getElementById('dd');
      const hh = document.getElementById('hh');
      const mm = document.getElementById('mm');
      const ss = document.getElementById('ss');

      function tick(){
        const t = target - new Date();
        if (t <= 0){
          dd.textContent = '00'; hh.textContent='00'; mm.textContent='00'; ss.textContent='00';
          document.querySelector('#countdown .cd-title').innerHTML = 'The doors are <span style="color:var(--blood)">OPEN</span>.';
          return;
        }
        const d = Math.floor(t/86400000);
        const h = Math.floor((t%86400000)/3600000);
        const m = Math.floor((t%3600000)/60000);
        const s = Math.floor((t%60000)/1000);
        dd.textContent = String(d).padStart(2,'0');
        hh.textContent = String(h).padStart(2,'0');
        mm.textContent = String(m).padStart(2,'0');
        ss.textContent = String(s).padStart(2,'0');
        requestAnimationFrame(()=>setTimeout(tick, 250));
      }
      tick();
    })();
  </script>

  <!-- ===== Puzzle ===== -->
  <script>
    const PUZZLE = [
      {id:1, code:'SHADOW-31', title:'Echo Trail',  room:'E-09-06', img:'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop'},
      {id:2, code:'SILENCE-09', title:'Silence Room', room:'D-09-06', img:'https://images.unsplash.com/photo-1482192505345-5655af888cc4?q=80&w=1200&auto=format&fit=crop'},
      {id:3, code:'TAPE-02', title:'Cassette', room:'E-09-02', img:'https://images.unsplash.com/photo-1548611716-0fae2c7d4d1c?q=80&w=1200&auto=format&fit=crop'},
      {id:4, code:'LIGHT-08', title:'Light of Death', room:'D-08-08', img:'https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=1200&auto=format&fit=crop'},
      {id:5, code:'MAP-01', title:'Map of Doom', room:'E-08-01', img:'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=1200&auto=format&fit=crop'},
      {id:6, code:'CURSE-07', title:'The Curse', room:'Level 7 (Block E to D, Every Class)', img:'https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=1200&auto=format&fit=crop'},
      {id:7, code:'JIANGSHI-01', title:'Jiangshi', room:'S-08-01', img:'https://images.unsplash.com/photo-1504194104404-433180773017?q=80&w=1200&auto=format&fit=crop'},
      {id:8, code:'DOORS-3', title:'Three Doors', room:'E-08-11 / S-08-05 / S-08-06 / S-08-07', img:'https://images.unsplash.com/photo-1523419409543-8f6f2f2a6f58?q=80&w=1200&auto=format&fit=crop'},
      {id:9, code:'RUSSIAN-07', title:'Russian Roulette', room:'S-07-02', img:'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop'}
    ];

    const GRID = document.getElementById('chestGrid');
    const input = document.getElementById('codeInput');
    const submit = document.getElementById('submitCode');
    const resetBtn = document.getElementById('resetCodes');
    const toast = document.getElementById('toast');
    const note  = document.getElementById('progressNote');

    const KEY = 'hallow-unlocked-v1';
    let unlocked = new Set(JSON.parse(localStorage.getItem(KEY) || '[]'));

    function renderGrid(){
      GRID.innerHTML = '';
      PUZZLE.forEach(item=>{
        const isOpen = unlocked.has(item.code);
        const card = document.createElement('div');
        card.className = `chest ${isOpen?'unlocked':'locked'}`;
        card.dataset.code = item.code;
        card.innerHTML = `
          <div class="reveal">
            <img src="${item.img}" alt="${item.title}" loading="lazy" style="${isOpen?'opacity:1;transform:scale(1)':'opacity:0;transform:scale(1.05)'}">
            <div class="label">
              <div class="label-title">${isOpen?item.title:'LOCKED'}</div>
              <div class="room" style="font-size:12px;opacity:.85">${isOpen?item.room:'Find the code'}</div>
            </div>
          </div>
        `;
        GRID.appendChild(card);
      });
      note.textContent = `${unlocked.size} / ${PUZZLE.length} unlocked`;
    }
    renderGrid();

    function showToast(msg, ok=false){
      toast.textContent = msg;
      toast.style.display = 'block';
      toast.style.color = ok ? '#9dffc4' : '#ffb3b3';
      setTimeout(()=>toast.style.display='none', 1600);
    }

    function tryCode(){
      const raw = input.value.trim().toUpperCase();
      if(!raw) return;
      const match = PUZZLE.find(x => x.code.toUpperCase() === raw);
      if(!match){ showToast('Nope. Keep searching.'); input.value=''; return; }
      if(unlocked.has(match.code)){ showToast('Already unlocked.', true); input.value=''; return; }

      unlocked.add(match.code);
      localStorage.setItem(KEY, JSON.stringify([...unlocked]));
      renderGrid();
      showToast(`Unlocked: ${match.title}!`, true);
      input.value = '';
    }

    submit.addEventListener('click', tryCode);
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') tryCode(); });
    resetBtn.addEventListener('click', ()=>{
      localStorage.removeItem(KEY);
      unlocked = new Set();
      renderGrid();
      showToast('Progress reset.');
    });
  </script>

  <!-- EmailJS optional (kept for fallback) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- ===== LIVE REGISTER: Apps Script integration ===== -->
  
</body>
</html>
