<!-- REGISTER START -->
<section id="register" style="max-width:900px;margin:0 auto;padding:80px 20px">
  <h2 style="font-family:Cinzel,serif;font-size:clamp(34px,4.6vw,56px);text-align:center;margin-bottom:10px;">
    Register for <span style="color:#b10f2e">Hallow Trials</span>
  </h2>
  <p class="muted" style="text-align:center;max-width:780px;margin:0 auto 18px;color:#9a94b8">
    Tickets are <strong>RM10</strong> per person.
    On submit weâ€™ll notify <strong>hallowtrials@gmail.com</strong>.
  </p>

  <div class="reg-card" style="background:#121018;border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.6)">
    <div id="regError" style="color:#ffb3b3;margin-top:8px;display:none"></div>

    <form id="regForm" class="reg-grid" autocomplete="on" novalidate
      style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:14px">

      <!-- Payment Method -->
      <div class="field full" style="grid-column:1 / -1;display:flex;flex-direction:column;gap:8px">
        <label style="font-weight:700;letter-spacing:.2px">Payment method</label><br>
        <div class="pay-methods" style="display:flex;gap:16px;flex-wrap:wrap">
          <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
            <input type="radio" name="payMethod" value="qr" style="accent-color:#b10f2e"> <span>DuitNow QR / Online Transfer</span>
          </label>
          <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
            <input type="radio" name="payMethod" value="bank" style="accent-color:#b10f2e"> <span>Bank Transfer</span>
          </label>
        </div><br>
      </div>

      <!-- QR block -->
      <div id="qrBlock" class="full" style="grid-column:1 / -1;display:none">
        <div class="qr-wrap" style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;background:#0b0b12;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px">
          <img src="qr.png" alt="Maybank DuitNow QR" style="width:140px;height:140px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.1)">
          <div>
            <p><b>Payee:</b> MUHAMMAD DANISH BIN MOHD</p><br>
            <p><b>Amount:</b> RM <span id="qrAmount">10</span></p><br>
            <p><b>Reference to include:</b> HALLOW TRIALS</p><br>
            <div class="muted" style="margin-top:6px;color:#9a94b8">After paying, upload your proof (screenshot/receipt) and tick the confirmation below.</div><br>

            <label class="field" style="display:flex;flex-direction:column;gap:6px;margin-top:10px">
              <span>Upload payment proof (image, max 5MB)</span>
              <input id="qrProof" type="file" accept="image/*" style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:10px;border-radius:10px">
            </label>
            <div id="qrPreview" class="muted" style="display:none;margin-top:6px;color:#9a94b8"></div><br>

            <label style="display:flex;align-items:center;gap:8px;margin-top:8px">
              <input type="checkbox" id="QRpaidConfirm"> <span>I understand that tickets are non-refundable</span>
            </label>

            <label class="field" style="display:flex;flex-direction:column;gap:6px;margin-top:10px">
              <br><span>Payment reference (optional)</span><br>
              <input id="payRef" placeholder="Maybank Ref No. / TNG ID"
                style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:12px;border-radius:12px">
            </label>
          </div>
        </div>
      </div>

      <!-- Bank block -->
      <div id="bankBlock" class="full" style="grid-column:1 / -1;display:none">
        <div class="qr-wrap" style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;background:#0b0b12;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px">
          <div>
            <p><b>Bank:</b> Maybank</p><br>
            <p><b>Account name:</b> MUHAMMAD DANISH BIN MOHD</p><br>
            <p><b>Account no.:</b> <code style="user-select:all">0101 8914 0360</code></p><br>
            <p><b>Amount:</b> RM <span id="bankAmount">10</span></p><br>
            <p class="muted" style="color:#9a94b8">Transfer using your bank to the account above, then upload your receipt below.</p><br>

            <label class="field" style="display:flex;flex-direction:column;gap:6px;margin-top:10px">
              <span>Upload payment proof (image, max 5MB)</span>
              <input id="bankProof" type="file" accept="image/*"
                style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:10px;border-radius:10px">
            </label>
            <div id="bankPreview" class="muted" style="display:none;margin-top:6px;color:#9a94b8"></div><br>

            <label style="display:flex;align-items:center;gap:8px;margin-top:8px">
              <input type="checkbox" id="BankpaidConfirm"> <span>I understand that tickets are non-refundable</span>
            </label>

            <label class="field" style="display:flex;flex-direction:column;gap:6px;margin-top:10px">
              <br><span>Payment reference (optional)</span>
              <input id="bankRef" placeholder="Bank/Card reference number"
                style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:12px;border-radius:12px">
            </label>
          </div>
        </div>
      </div>

      <div class="field">
        <label for="fullName" style="font-weight:700">Full Name </label>
        <input id="fullName" name="fullName" placeholder="Ashmit Dhir"
          style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:12px;border-radius:12px" required>
      </div>

      <div class="field">
        <label for="email" style="font-weight:700">Email</label>
        <input id="email" name="email" type="email" placeholder="you@example.com"
          style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:12px;border-radius:12px" required>
      </div>

      <div class="field">
        <br>
        <label for="qty" style="font-weight:700">Number of tickets</label><br><br>
        <select id="qty" name="qty"
          style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:12px;border-radius:12px">
          <option value="1" selected>1</option>
        </select><br><br>
      </div>

      <div class="field">
        <br>
        <label style="font-weight:700">Total price</label>
        <br><br>
        <div class="price">RM <span id="totalPrice">10</span></div>
      </div>

      <div class="field full" style="grid-column:1 / -1">
        <label for="note" style="font-weight:700">TP number</label><br>
        <label for="note" style="font-weight:700">(Answer n/a if outside APU)</label><br><br>
        <input id="note" name="note" placeholder="Your TP Number" required
          style="background:#0b0b12;border:1px solid rgba(255,255,255,.12);color:#e6e3ff;padding:12px;border-radius:12px">
      </div>

      <div class="full" style="grid-column:1 / -1;display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:6px">
        <button id="submitReg" class="btn" type="submit"
          style="border:none;background:linear-gradient(180deg,#1c1529,#0f0a14);color:#e6e3ff;padding:14px 24px;border-radius:14px;font-weight:700">
          Reserve My Spot
        </button>
        <span id="regStatus" class="muted" role="status" aria-live="polite" style="color:#9a94b8"></span>
      </div>
    </form>
  </div>
</section>

<!-- Mobile-only tweaks for the register grid/buttons (no desktop change) -->
<style>
  @media (max-width: 640px){
    #register .reg-grid{ grid-template-columns:1fr; gap:14px }
    #register .pay-methods{ gap:12px }
    #register .qr-wrap{ padding:10px }
    #register .btn{ width:100%; padding:16px } /* big tap target */
  }
</style>

<script>
(function registerSection(){
  /* Config */
  const API_URL = 'https://script.google.com/macros/s/AKfycbxlEAVWRpncfClDj5MaEfg93nByp3wuyMsUFZiiWQHe8ueKT1BnItp2KwXVYOoKI5c/exec';
  const PRICE = 10;
  const EMAILJS_PUBLIC_KEY='YOUR_PUBLIC_KEY_HERE', EMAILJS_SERVICE_ID='YOUR_SERVICE_ID', EMAILJS_TEMPLATE_ID='YOUR_TEMPLATE_ID';
  if (EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY!=='YOUR_PUBLIC_KEY_HERE') emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });

  /* DOM */
  const form = document.getElementById('regForm');
  const qtySel = document.getElementById('qty');
  const totalPriceEl = document.getElementById('totalPrice');
  const submitBtn = document.getElementById('submitReg');
  const regStatus = document.getElementById('regStatus');
  const regError = document.getElementById('regError');

  const payMethodInputs = document.querySelectorAll('input[name="payMethod"]');
  const qrBlock = document.getElementById('qrBlock');
  const bankBlock = document.getElementById('bankBlock');
  const QRpaidConfirm= document.getElementById('QRpaidConfirm');
  const BankpaidConfirm= document.getElementById('BankpaidConfirm');
  const payRef = document.getElementById('payRef');
  const bankRef = document.getElementById('bankRef');
  const qrAmount = document.getElementById('qrAmount');
  const bankAmount = document.getElementById('bankAmount');
  const qrProof = document.getElementById('qrProof');
  const bankProof = document.getElementById('bankProof');
  const qrPreview = document.getElementById('qrPreview');
  const bankPreview= document.getElementById('bankPreview');

  /* Helpers */
  const notify = (m)=>alert(m);
  const currentPayMethod = ()=>{ const m=[...payMethodInputs].find(r=>r.checked); return m?m.value:'cash'; };
  function refreshPrice(){
    const total=(Number(qtySel.value)||1)*PRICE;
    totalPriceEl.textContent=String(total);
    qrAmount.textContent=String(total);
    bankAmount.textContent=String(total);
  }
  function updatePaymentUI(){
    const method=currentPayMethod();
    qrBlock.style.display   = method==='qr'   ? 'block' : 'none';
    bankBlock.style.display = method==='bank' ? 'block' : 'none';
    refreshPrice();
  }
  function previewFile(inputEl, previewEl){
    const file=inputEl.files && inputEl.files[0];
    if(!file){ previewEl.style.display='none'; previewEl.innerHTML=''; delete previewEl.dataset.base64; return; }
    if(file.size>5*1024*1024){ inputEl.value=''; previewEl.style.display='block'; previewEl.textContent='File too large (max 5MB).'; delete previewEl.dataset.base64; return; }
    const reader=new FileReader();
    reader.onload=()=>{ previewEl.style.display='block'; previewEl.innerHTML=`<img src="${reader.result}" alt="proof" style="max-width:160px;max-height:160px;border-radius:8px;border:1px solid rgba(255,255,255,.15)">`; previewEl.dataset.base64=reader.result; };
    reader.readAsDataURL(file);
  }
  function openGmailCompose({ to, subject, body }) {
    const url = `https://mail.google.com/mail/?view=cm&fs=1&tf=1`
      + `&to=${encodeURIComponent(to)}`
      + `&su=${encodeURIComponent(subject)}`
      + `&body=${encodeURIComponent(body)}`;
    // Navigate ONLY after success; stays in same tab (no about:blank)
    window.location.href = url;
  }

  async function apiRegister(payload){
    const res=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
    const text=await res.text(); let data;
    try{ data=JSON.parse(text);}catch(e){ throw new Error('Bad JSON: '+text); }
    if(!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
    return data;
  }

  /* Init */
  document.addEventListener('DOMContentLoaded', ()=>{
    payMethodInputs.forEach(r=>r.addEventListener('change',updatePaymentUI));
    qtySel.addEventListener('change',refreshPrice);
    qrProof.addEventListener('change',()=>previewFile(qrProof,qrPreview));
    bankProof.addEventListener('change',()=>previewFile(bankProof,bankPreview));
    refreshPrice(); updatePaymentUI();
  });

  /* Submit */
  form.addEventListener('submit', async (e)=>{
    e.preventDefault(); regStatus.textContent=''; regError.style.display='none';
    const fullName=document.getElementById('fullName').value.trim();
    const email=document.getElementById('email').value.trim();
    const qty=Number(qtySel.value)||1;
    const noteEl=document.getElementById('note');
    const note=noteEl.value.trim();
    const total=qty*PRICE;

    if(!fullName || !email){ notify('Please fill your name and a valid email.'); return; }
    if(!note){
      const msg='Please enter your TP Number.';
      noteEl.setCustomValidity(msg); noteEl.reportValidity();
      noteEl.addEventListener('input',()=>noteEl.setCustomValidity(''),{once:true});
      regError.style.display='block'; regError.textContent=msg;
      return;
    }

    const payMethod=currentPayMethod(); let reference=''; let proofDataURL='';
    if(payMethod==='qr'){
      if(!QRpaidConfirm || !QRpaidConfirm.checked){ notify('Tick the confirmation box after completing the QR/transfer.'); return; }
      if(!qrPreview.dataset.base64){ notify('Please upload your QR payment screenshot.'); return; }
      proofDataURL=qrPreview.dataset.base64; reference=(payRef && payRef.value || '').trim();
    }
    if(payMethod==='bank'){
      if(!BankpaidConfirm || !BankpaidConfirm.checked){ notify('Tick the confirmation box after completing the Bank transfer.'); return; }
      if(!bankPreview.dataset.base64){ notify('Please upload your bank/card receipt screenshot.'); return; }
      proofDataURL=bankPreview.dataset.base64; reference=(bankRef && bankRef.value || '').trim();
    }

    submitBtn.disabled=true; submitBtn.textContent='Processingâ€¦';
    try{
      const resp=await apiRegister({ fullName,email,qty,total,payMethod,reference,note,imageDataURL:proofDataURL || '' });
      const proofLink=resp.proofUrl || '';

      if (EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY!=='YOUR_PUBLIC_KEY_HERE'){
        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
          to_email:'hallowtrials@gmail.com', full_name:fullName, email,
          qty:String(qty), total_rm:String(total), note,
          pay_method:payMethod, pay_reference:reference || '', proof_link:proofLink
        });
      } else {
        const subject='Hallow Trials Registration';
        const lines=[
          'New registration:',
          `Name: ${fullName}`,
          `Email: ${email}`,
          `Qty: ${qty}`,
          `Total: RM ${total}`,
          `Payment: ${payMethod}${reference ? ' ('+reference+')' : ''}`,
          `Proof link: ${proofLink || '-'}`,
          `TPNumber: ${note || '-'}`
        ];
        openGmailCompose({ to:'hallowtrials@gmail.com', subject, body:lines.join('\n') });
      }

      notify('Booking received! Check your email.');
      regStatus.textContent=`Booked ${qty} ticket(s). Total RM${total}.`;
      form.reset(); refreshPrice(); updatePaymentUI();
      [qrPreview,bankPreview].forEach(el=>{el.style.display='none';el.innerHTML='';delete el.dataset.base64;});
    }catch(err){
      console.error(err);
      notify('Failed to register: '+err.message);
      regStatus.textContent='Error. Please try again or email us directly.';
    }finally{
      submitBtn.disabled=false; submitBtn.textContent='Reserve My Spot';
    }
  });
})();
</script>
<!-- REGISTER END -->
